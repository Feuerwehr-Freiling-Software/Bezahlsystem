@page "/user/profile"
@using System.Security.Claims;
@using OAOPS.Client.Services;
@attribute [Authorize]

@inject AuthenticationStateProvider authStateProvider
@inject IDataService DataService

@if (UserStats == null)
{
    <OAOPS.Client.Components.Shared.LoadingComponent></OAOPS.Client.Components.Shared.LoadingComponent>
}
else
{
    <MudGrid Justify="Justify.Center" Class="mt-5">
        <MudItem xs="5">
            <MudText Typo="Typo.h4">@user.Identity?.Name's Profil </MudText>
        </MudItem>
        <MudItem xs="5">
            <MudText Typo="Typo.h4">Kontostand: @balance</MudText>
        </MudItem>
        <MudItem xs="5">
            <MudPaper>
                @if (ArticleData.Length == 0)
                {
                    <MudText Typo="Typo.h4">Keine Daten verfügbar.</MudText>
                }else
                {
                    <!-- Add chart for Article distribution -->
                    <MudChart @ref="mudChart" ChartType="ChartType.Pie" @bind-SelectedIndex="Index" InputData="@ArticleData" InputLabels="@ArticleLabels" Width="300px" Height="300px"/>
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="5">
            <MudPaper>
                <!-- Add chart for Payment distribution -->
                <MudChart ChartType="ChartType.Line" ChartSeries="@PaymentData" XAxisLabels="@PaymentLabels" ></MudChart>
            </MudPaper>
        </MudItem>
        <MudItem xs="5">
            <MudPaper>
                <!-- ImageButton for Payments -->
            </MudPaper>
        </MudItem>
        <MudItem xs="5">
            <MudPaper>
                <!-- ImageButton for Top Ups-->
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code{
    private int Index = -1;
    ClaimsPrincipal user;
    bool isAdmin;
    bool isAuthenticated;
    string balance;

    public MudChart mudChart = new();

    override protected async Task OnInitializedAsync()
    {
        mudChart = new();
        
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        user = authState.User;

        isAdmin = user.IsInRole("Admin");

        var userName = user.Identity?.Name;

        if (userName == null)
        {
            balance = 0.ToString("C2");
            return;
        }

        var retBal = await DataService.GetBalance(userName);
        balance = retBal.ToString("C2");

        await GetUserStats();

        await InvokeAsync(StateHasChanged);
    }
}